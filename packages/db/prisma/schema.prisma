generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id @map("_id")
  name          String
  email         String
  emailVerified Boolean      @default(false)
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  sessions      Session[]
  accounts      Account[]
  location      Location?
  member        Member[]
  invitation    Invitation[]
  scans         Scan[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String   @id @map("_id")
  expiresAt            DateTime
  token                String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  activeOrganizationId String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @map("_id")
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @map("_id")
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id          String       @id @map("_id")
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  scans       Scan[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @map("_id")
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member") // e.g., "owner", "admin", "viewer"

  // --- JURISDICTION CONTROL ---
  // Stores the scope of this admin's power.
  // Structure: { state: "Maharashtra", district: "Kolhapur", taluka: "Hatkanangale" }
  // If a field is missing, they have no power at that level.
  // If a field is "*", they have full power.
  jurisdiction Json?

  createdAt DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id @map("_id")
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

model Location {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Coordinates (From GPS)
  latitude  Float
  longitude Float

  // Address Details
  address String?

  // --- API VALIDATED FIELDS ---
  // These must match the India Location API values exactly
  state    String // e.g. "Maharashtra"
  district String // e.g. "Kolhapur"
  taluka   String? // e.g. "Hatkanangale" (Sub-District/Tehsil)
  village  String? // e.g. "Wathar"

  city    String? // Optional: User might enter a nearby city if village is missing
  pincode String
  country String  @default("India")

  // Relation to User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for Geo-Spatial lookups (if needed later)
  @@index([state, district, taluka])
}

model Scan {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 1. CLOUDINARY DATA
  imageUrl String
  publicId String

  // 2. AI METADATA 
  crop        String
  visualIssue String?
  diagnosis   String?
  confidence  Float?

  // 3. LOCATION SNAPSHOT 
  // Copied from User.location at upload time.
  // WE MUST COPY ALL LEVELS to enable fast Admin Filtering.
  state     String? // <-- NEW: Allows "State Level" dashboards
  district  String?
  taluka    String? // <-- NEW: Allows "Taluka Level" dashboards
  village   String?
  city      String?
  pincode   String?
  latitude  Float?
  longitude Float?

  // 4. RELATIONS
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?       @map("organizationId")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // 5. INDEXES (Powering "The Watchtower")
  @@index([userId])
  @@index([organizationId])
  // Dashboard Queries:
  // "Show me all scans in Maharashtra"
  @@index([state, createdAt])
  // "Show me all scans in Kolhapur"
  @@index([district, createdAt])
  // "Show me all scans in Hatkanangale"
  @@index([taluka, createdAt])
  @@map("scan")
}
